# 終値ベースAIモデル 引き継ぎ資料（2025-10-05）

## 1. 目的と全体像
- **目的**: 前日の終値で買い、翌営業日の終値で1%以上値上がりする銘柄を事前に推奨する。
- **仕組みの流れ**:
  1. J-Quants APIから日経225銘柄の株価を取得（調整後終値を使用）。
  2. 外部指標（為替、VIXなど）を統合して特徴量を作成。
  3. LightGBMモデルが翌日終値上昇確率を予測。
  4. レポートで推奨銘柄（TOP3・確率70%以上、セクター重複最大2銘柄）を提示。

## 2. ファイル配置と主要スクリプト
| 役割 | 場所 | 実行例 |
| --- | --- | --- |
| 日次自動実行 | `daily_trading_automation.py` | `python daily_trading_automation.py` |
| モデル再学習 | `systems/enhanced_close_return_system_v1.py` | `python systems/enhanced_close_return_system_v1.py --target-return 0.01 --imbalance-boost 1.2` |
| 推奨レポート | `reports/daily_stock_recommendation_close_v1.py` | `python reports/daily_stock_recommendation_close_v1.py --date 2025-10-02` |
| 閾値最適化 | `analysis/close_threshold_optimizer.py` | `python analysis/close_threshold_optimizer.py --transaction-cost 0.002` |
| TOPN比較 | `analysis/close_topn_evaluation.py` | `python analysis/close_topn_evaluation.py --transaction-cost 0.002 --apply-config` |
| モニタリング | `analysis/close_monitoring_report.py` | `python analysis/close_monitoring_report.py` |

## 3. 現状のセットアップ
- **モデル**: `models/enhanced_close_v1/close_model_v1_0.6720acc_20251005_192706.joblib`
  - LightGBM（学習率0.02、max_depth=8、num_leaves=63 など）
  - 正例ラベル: 翌営業日終値が +1.0%以上
  - 確率校正: モデル保存時にロジスティック回帰で補正係数を保存
- **推奨条件**（`config/close_recommendation_config.json`）
  - `target_return`: 0.01（+1.0%）
  - `min_probability`: 0.70（最適化結果）
  - `top_n`: 3
  - `max_per_sector`: 2
- **最新のレポート例**: `production_reports/2025-10/2025-10-02.md`

## 4. ここまでの改善内容
1. **データ品質**: マッピング欠損（日本軽金属HD・東洋紡・マルハニチロ）を追加、欠損推奨ゼロ。
2. **ラベル/閾値**: コスト控除、ROC/PR-AUCを算出。最適閾値（0.70）を自動更新するスクリプトを導入。
3. **特徴量拡張**: ギャップ、3日リターン、出来高Zスコア、指数乖離などを追加。
4. **ハイパーパラメータ**: グリッドサーチで最良パラメータを探索して適用。
5. **不均衡対策**: `--imbalance-boost` で陽性重みを調整可能に。
6. **確率キャリブレーション**: ロジスティック補正で確信度の信頼性向上。
7. **モニタリング**: 閾値別・TopN別の成績を自動生成 (`reports/monitoring/` フォルダ)。
8. **推奨数/セクター制御**: 設定ファイルから自動読込し、セクター上限で調整。

## 5. 現状の成績（2025-09-01〜2025-10-02、79件）
- ヒット率: 32.9%（翌日終値が +1.0% 以上）
- 累計損益: +24.47%（1単位/銘柄、コスト考慮なし）
- 閾値0.6% & コスト0.2%ではネットリターンほぼゼロ → 収益確保には閾値調整が必須
- TOP3 & 確率0.60でヒット率36.4%、0.65では34.6%（やや減少）

## 6. 今後の優先タスク（No.2 / No.8 完了済、残タスク）
| 優先度 | 施策 | 目的 | 初動の目安 |
| --- | --- | --- | --- |
| ★★★ | 再学習トリガー運用（No.9） | 週次モニタリング結果から閾値/パラメータを再評価 | `analysis/close_monitoring_report.py` を週1実行し記録 |
| ★★☆ | 回帰モデル検証（No.2発展） | 翌日リターン自体を予測し、確率換算する | `systems/enhanced_close_return_system_v1.py` の別モード実装 |
| ★★☆ | 業種定義の精緻化（No.8発展） | CSVにセクターを補完、同業比率の偏りを監視 | `docment/ユーザー情報/nikkei225_matched_companies_*.csv` の更新 |
| ★☆☆ | 不均衡学習の追加手法 | Focal loss / SMOTEなどの導入検討 | 試験的に別モデルで実験 |
| ★☆☆ | アンサンブル検討（No.10） | LightGBMに加えXGBoost等を投票 | 単一モデルが頭打ち後に着手 |

## 7. 日々の運用チェック項目
- `reports/monitoring/threshold_summary.csv` / `topn_summary.csv` に異常がないか
- `daily_trading_automation.py` 実行ログ (`daily_automation.log`) にエラーがないか
- `production_reports/YYYY-MM` に最新レポートが生成されているか
- モデル更新後は必ず `analysis/close_threshold_optimizer.py` と `analysis/close_topn_evaluation.py` を実行し、設定反映

## 8. トラブルシューティング
- **レポートが空になる**: 閾値が高すぎる場合 → `config/close_recommendation_config.json` の `min_probability` を下げるか CLI で上書き。
- **セクター情報が "Unknown" になる**: CSVに `sector` 列が未記載 → `docment/ユーザー情報/nikkei225_matched_companies_*.csv` を更新。
- **閾値最適化でエラー**: 最新モデルが存在するか (`models/enhanced_close_v1/close_model_v1_*.joblib`) を確認。

## 9. 参考ドキュメント
- `docment/ユーザー情報/終値モデル磨き込み計画_20251005.md` … 改善施策と進捗一覧
- `docment/ユーザー情報/終値モデル運用フロー.md` … 日次オペレーション、再学習手順

---
不明点は `analysis/` スクリプトのコメント、または `docment/ユーザー情報/終値モデル磨き込み計画_20251005.md` を参照してください。EOF
