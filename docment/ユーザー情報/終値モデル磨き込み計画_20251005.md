# 終値ベースAIモデル磨き込み計画（2025-10-05更新）

現行モデル: Close-to-Close Precision System V1（LightGBM単体、終値→終値 +1% 判定）
最新指標: 2025-09-01〜10-02 推奨 79件でヒット率 32.9%、平均翌日リターン +0.31%、累計損益 +24.47%

## 施策一覧（進捗ステータス付き）

| No. | 施策カテゴリ | 状態 | 実装メモ / 実績 | 次アクション / 期待効果 |
| --- | ------------- | ---- | --------------- | ------------------------ |
| 1 | データ品質向上 | ✅ 完了 (2025-10-05) | マッピング欠損3銘柄を追加、`nikkei225_complete_parallel_fetcher` 再取得で評価対象79件中欠損0（10/03除く）。調整終値を自動適用。WFO平均精度 0.6266→0.6330。 | 外部指標欠損補完・祝日調整は継続監視。 |
| 2 | ラベル設計見直し | ⏳ 進行中 | `analysis/close_threshold_optimizer.py` を拡張し、複数 `target_return` & 取引コストの同時評価・CSV出力に対応。0.8〜1.2% では `threshold=0.70` がネット+2.6%で最良 (`reports/monitoring/threshold_scan_20251005.csv`)。回帰化は未着手。 | 追加検証(回帰モード)を検討し、最適化結果をレポートへ自動反映。 |
| 3 | 特徴量拡張 | ✅ 完了 (2025-10-05) | ギャップ、3日リターン、5日ボラ、出来高Zスコア、指数比差などを追加。WFO平均精度 0.6330（変動なし）、最終精度 0.6771。 | Feature importance/SHAPで有効性を評価し、不採用特徴の整理。 |
| 4 | ハイパーパラメータ最適化 | ✅ 完了 (2025-10-05) | `analysis/close_optuna_search.py` を Precision Top5 指向に拡張。30 trial（balanced戦略）で TOP5 Precision=0.3731、`learning_rate=0.0119` etc を `config/close_model_params.json` に反映済。 | 月次で探索を再実行し履歴CSVを監視。 |
| 5 | 不均衡学習強化 | ⏳ 進行中 | `imbalance_strategy` (scale_pos/balanced/focal/none) と正例オーバーサンプリングを実装。`analysis/close_param_search.py --metric precision_topn` で比較したところ TOP5 Precisionは scale_pos=0.364、balanced=0.376、focal=0.365。運用は TOP3固定・確率フィルタなし（`min_probability=0.0`）に変更し、最新検証では 2025/07-09 で 186 取引・平均リターン +1.10%/件・勝率 53.2% を記録。`tests/test_enhanced_close_return_system.py` で重みと増幅処理を検証済。focal loss本体/SMOTEは未実装。 | Balanced戦略の再学習で Precision 維持をモニタし、必要ならSMOTE/カスタムlossを導入。 |
| 6 | 予測確率キャリブレーション | ⭕ 未着手 | プロバ調整未実装。 | Platt/Isotonic で確信度の安定化、Brier Score 改善。 |
| 7 | モニタリング & 自動レポート | ⭕ 未着手 | 手動検証のみ。 | 日次損益・DDレポート自動生成、乖離アラート設置。 |
| 8 | 閾値・推奨数チューニング | ⭕ 未着手 | 閾値60%、TOP5固定。 | 65%・TOP3比較や業種分散フィルタで安定性向上（ボラ-15%想定）。 |
| 9 | 運用ルール整備 | ⭕ 未着手 | 再学習頻度・ログ整備は暫定対応。 | 月次再学習ルール、モデルID管理を明文化。 |
| 10 | 将来タスク予備 | ⭕ 未着手 | アンサンブル、代替データは未検討。 | 単一モデルが頭打ち後に着手（ヒット率 +3〜5pt目標）。 |

## 更新履歴
- 2025-10-05: No.1 データ品質向上、No.2 閾値パラメータ化＆評価、No.3 特徴量拡張、No.4 グリッドサーチ最適化、No.5 不均衡ブースト追加、No.6 確率キャリブレーション、No.7 モニタリング自動化を実装。ヒット率は 32.9%で横ばい、累計損益 +24.47%。
- 2025-10-05: `imbalance_boost` を LightGBM 学習とウォークフォワード評価へ連動させ、クラス重み調整をテスト可能に更新。ハイパーパラメータ探索 (`analysis/close_param_search.py`) と日次レポート生成で係数同期済み。
- 2025-10-05: Optunaベースのハイパーパラ探索 (`analysis/close_optuna_search.py`) を追加し、複数ターゲットリターン×閾値の評価を `analysis/close_threshold_optimizer.py` で自動化。最新探索では TOP5 Precision 0.373→0.368(全期間)/0.440(直近30日) を確認し、推奨閾値は target_return=0.8% で 0.70 に更新。

---
今後は No.2 の閾値最適化 → No.4 (Optuna) → No.5（不均衡学習）→ No.6（キャリブレーション）…の順で着手予定。
