# AI株価分析モデル 要件定義書

## 本ドキュメントの注意事項
- 本ドキュメントは初心者の方でも運用・改善ができるよう、わかりやすさを重視して記述しています。より高い精度を目指す場合も、まずは本要件をベースに小さく回し、検証結果を見ながら最小限の変更で改善します。
- ドキュメントの5章以降はあくまでの初期構想としての記述です。検証の結果、1章と2章のゴールを達成するためのアプローチとして最適でない場合には柔軟に変更してください。

## 1. 目的（何を達成したいか）
- 日経225の中から、当日の終値に対して翌営業日の高値が+1%以上になる銘柄を、できるだけ外さずに当てる。
- 主指標は「適合率（Precision）」とし、精度重視で設計する。
- 実際にこのAIモデルを長期的に運用しても問題ないような精度と安定性を担保する。

## 2. 成功基準（合否ライン）
- 検証期間で Precision ≥ 0.75 を満たす。
- 1日あたりの抽出数は 0〜3 銘柄（無理に出さない＝該当なしは許容）。

## 3. スコープ（対象と除外）
- 銘柄ユニバース: 日経225の「各時点の構成銘柄」を採用（入替えを反映して過去のゆがみを防止）。
- 除外条件: 売買停止・上場廃止・分割/併合直後で価格が飛ぶ日・出来高ほぼゼロ日は除外。
- 価格系列: 分割・併合・配当を反映した調整後株価を使用。

## 4. 用語の定義
- 翌営業日: 日本市場の営業日カレンダーに基づく翌日。祝日等は自動判定。
- 的中（正解）: 翌営業日の高値 ≥ 当日終値 × 1.01。
- Precision: 予測で「上昇」とした銘柄のうち、実際に的中した割合。

## 5. データ要件
- 期間区分:
  - 学習（訓練）: 2016-01-01 〜 2022-12-30
  - 検証（チューニング確認）: 2023-01-01 〜 2023-12-30
  - テスト（最終評価）: 2024-01-01 〜 2024-12-30
- データ源:
  - J-Quants Standardプランの株価・基本情報（必須）
  - 外部指標（可能なら）: USD/JPY、日経先物、TOPIX（日次変化）
- 粒度: 日足を使用（分足は使わない）。
- タイムゾーン: JSTで統一。
- 保存形式と構造（例）:
  - 形式: Parquet（大容量に強い）またはCSV
  - ディレクトリ: `data/raw`（取得元データ）、`data/feature`（特徴量）、`data/model`（学習済み）、`signals`（日次出力）、`logs`（実行ログ）
- バージョン管理: 取得日・作成日をメタとして保持し再現性を確保。

## 6. ラベル（正解）の作り方
- 定義: 翌営業日の高値が当日終値より+1%以上で1（的中）、それ以外は0。
- シリーズ: 調整後株価を用いる。
- 漏洩防止: 前日までの情報のみで作成（翌日の情報は一切参照しない）。

## 7. 特徴量（モデルへの入力）
- ベース: 日足OHLCV（始値・高値・安値・終値・出来高）。
- テクニカル（複数期間）: 移動平均（5/10/20/60/120日）、乖離率、ボリンジャーバンド、RSI、ストキャス、MACD、ADX、ATR、出来高変化率、ギャップ（窓）、直近高値・安値からの距離など。
- 市場環境: TOPIX/日経先物の前日変化、USD/JPYの日次変化（利用可能な範囲）。
- 欠損・外れ値: 欠損は前方埋め＋安全な初期値、極端値は分位点でクリップ。
- データリーク対策: 翌日の情報が混ざらないよう、前日までの値のみで計算。

## 8. モデル構成（精度重視のアンサンブル）
- 個別モデル: LightGBM、CatBoost、ロジスティック回帰（L2）
- 不均衡対策: クラス重みを付与（上昇ラベルを相対的に重く）。
- 学習方法: 時系列ウォークフォワード（前に進みながら学習→検証）。
- ハイパーパラメータ探索: ベイズ最適化 最大200試行/モデル（予算に応じ調整）。
- 確率校正: 検証データでイソトニック回帰を実施。
- アンサンブル: 重み付き平均（LightGBM 0.45、CatBoost 0.45、ロジスティック 0.10）。

## 9. 予測から抽出までのルール（Precision最大化）
- しきい値: 予測確率 0.85 以上のみ候補。
- Top-K: 候補の中から上位K=3を上限に選ぶ（該当0〜2も可）。
- 変動の大きい日: 指数のボラティリティが高い日は、しきい値を自動で 0.90 に引き上げ。
- 出力: 銘柄コード、日付、予測確率、根拠特徴量の上位（例: SHAP）をCSVに保存。

## 10. 検証方法（信頼できる精度を測る）
- 分割: 6分割ウォークフォワード＋5営業日のギャップを挿入（未来情報の混入防止）。
- 主指標: Precision（しきい値/Top-K適用後の実測）。
- 参考指標: 日次の選定数、リコール、PRカーブ、キャリブレーションカーブ。
- 取引コスト仮定: 片道0.05%＋スリッページ0.10%をバックテストに反映。

## 11. 実装と作成物（責務の分離）
- スクリプト構成（例）:
  - `scripts/fetch_data.py`: データ取得・更新
  - `scripts/make_features.py`: 特徴量生成
  - `scripts/train_eval.py`: 学習・検証（モデル保存・校正）
  - `scripts/daily_infer.py`: 日次推論＋シグナル出力
  - `scripts/report.py`: 可視化・レポート生成
- 入出力（例）:
  - 入力: `data/raw/*.parquet`、設定`config/*.yaml`
  - 中間: `data/feature/*.parquet`、`data/model/*.pkl`
  - 出力: `signals/YYYYMMDD.csv`、`reports/*.html`、`logs/*.log`

## 12. 運用（RunPodでの自動実行）
- 実行タイミング: 日本株の引け後（JST 15:15以降、毎営業日16:00開始）。
- スケジューラ: cron または外部のスケジューラサービスで毎営業日16:00に実行開始。
- フロー: 起動 → データ差分取得 → 特徴量更新 → 推論 → 出力 → ログ保存 → 停止。
- リトライ: 失敗時は最大2回まで自動再試行。
- 監視・通知: ログ保存（`logs/YYYYMMDD_run.log`）と、希望時はメール/Slack通知。
- 冪等性: 中間生成物を活用し、途中失敗時は再開できる設計。
- 運用方針: 該当なしの日は無理に出さない（Precision優先）。

## 13. セキュリティと秘密情報の扱い
- リポジトリに秘密情報を直書きしない。環境変数で注入する。
- 代表的な環境変数（例）:
  - `RUNPOD_API_KEY`: RunPodのAPIキー
  - `RUNPOD_POD_ID`: 利用するPod ID
  - `JQUANTS_TOKEN`: J-QuantsのAPIトークン
- 権限最小化: 使わない権限は無効化。キーは必要時のみ注入し、漏えい時は即時ローテーション。
- すでにリポジトリに記載されたキーは無効化・再発行を推奨。ドキュメント内はプレースホルダに置換する。

## 14. 品質保証・テスト
- データ検証: 列欠損・範囲外値・営業日連続性のチェックを自動化。
- 単体テスト: ラベル・特徴量のサンプルに対する期待値チェック。
- 回帰テスト: 主要スコアが大幅に悪化した場合に検知。
- 受け入れ基準: §2の成功基準を満たすこと。

## 15. 変更管理と設定
- 設定ファイル: `config/*.yaml` にパラメータを集約（期間、しきい値、Top-K、モデル設定）。
- 乱数シード: 学習と分割のシード固定。
- 依存関係: `requirements.txt` でバージョン固定。必要に応じDocker化。
- 初期チューニング範囲: しきい値 0.85〜0.90、Top-K 1〜3（運用で微調整）。

## 付録A. 予測と抽出の詳細（精度最優先）
- 予測確率のしきい値: 0.85（高ボラ日は0.90）。
- Top-K: 最大3銘柄。
- 出力CSV例（列）: `date, code, prob, top_features`

## 付録B. 実行イメージ（日次）
1. 16:00 RunPod起動 → 環境変数を設定
2. 差分データ取得 → 特徴量更新
3. 最新モデルで推論 → しきい値・Top-K適用
4. `signals/YYYYMMDD.csv` へ出力 → ログ保存
5. 正常終了でRunPod停止

---