# データ使用状況レポート

**作成日**: 2025年8月30日  
**実装フェーズ**: Phase 7完了時点（評価・検証システム）

## 概要

現在の実装段階で使用しているデータの種類、期間、形式について詳細に記載します。これは最終的な本格運用データではなく、開発・テスト段階で使用している実際のデータ情報です。

## 1. 実際に存在するデータファイル

### 1.1 外部指標データ（実データ）

**ファイル場所**: `data/raw/`

#### USD/JPYデータ
- **ファイル**: `external_usdjpy_2022-11-02_2023-04-11.parquet`
- **データ期間**: 2022年11月2日 ～ 2023年4月11日（約5.3ヶ月、114営業日）
- **データソース**: Yahoo Finance（USDJPY=X）
- **タイムゾーン**: Europe/London
- **含有データ項目**:
  - 基本OHLCV（Open, High, Low, Close, Volume）
  - Dividends, Stock_Splits（通貨ペアなので0）
  - symbol: "USDJPY=X"
  - daily_return: 日次リターン
  - log_return: 対数リターン
  - volatility_20d: 20日ローリングボラティリティ
  - volatility_5d: 5日ローリングボラティリティ
  - usdjpy_ma20: 20日移動平均
  - usdjpy_ma5: 5日移動平均
  - usdjpy_deviation: 移動平均からの乖離率

#### VIX指数データ
- **ファイル**: `external_vix_2022-11-02_2023-04-11.parquet`
- **データ期間**: 2022年11月2日 ～ 2023年4月11日（約5.3ヶ月、108営業日）
- **データソース**: Yahoo Finance（^VIX）
- **タイムゾーン**: America/Chicago
- **含有データ項目**:
  - 基本OHLCV（Open, High, Low, Close, Volume）
  - Dividends, Stock_Splits（指数なので0）
  - symbol: "^VIX"
  - daily_return: 日次リターン
  - log_return: 対数リターン
  - volatility_20d: 20日ローリングボラティリティ
  - volatility_5d: 5日ローリングボラティリティ
  - vix_ma10: 10日移動平均
  - vix_spike: VIXスパイク検出フラグ

### 1.2 日本株データ（設定のみ、実データなし）

**現在の状況**: J-Quants APIクライアントは実装済みだが、実際の日本株データは保存されていない

**API設定**:
- **データソース**: J-Quants API（https://api.jquants.com）
- **対象銘柄**: 日経225構成銘柄（動的取得予定）
- **設定期間**: 2016年1月1日 ～ 2024年12月31日（config.yaml設定値）
- **実装機能**:
  - 認証トークン管理
  - レート制限対応（100リクエスト/分）
  - 株価データ取得（OHLCV + 調整後価格）
  - 銘柄マスタ情報取得

## 2. テスト用サンプルデータ

### 2.1 Phase 7評価システムのテストデータ

#### バックテストテスト用データ
- **期間**: 2024年1月1日 ～ 2024年2月29日（約2ヶ月、営業日のみ）
- **銘柄**: ['1301', '1332', '1333']（サンプル3銘柄）
- **予測データ**: 47件の予測レコード
- **株価データ**: 132件の価格レコード
- **生成方法**: プログラマティックに生成（test_backtest_visualization.py）

#### 精度分析テスト用データ
- **期間**: 2024年1月1日 ～ 2024年4月30日（4ヶ月）
- **銘柄**: ['1301', '1332', '1333', '4755', '6758', '7203', '8035', '9432', '9984']（9銘柄）
- **セクター情報**: ['Materials', 'Energy', 'Energy', 'IT', 'Electronics', 'Auto', 'Trading', 'Telecom', 'IT']
- **予測データ**: 121件の予測レコード
- **実績データ**: 121件の実績レコード
- **市場データ**: 87件の市場環境データ
- **生成方法**: プログラマティックに生成（test_accuracy_analysis_extended.py）

## 3. データ形式とスキーマ

### 3.1 Parquetファイル共通仕様

**使用ライブラリ**: PyArrow 20.0.0, Pandas 2.3.0
**圧縮**: Snappy（設定上は可能、実際は無圧縮）

### 3.2 外部指標データスキーマ

```
- date: datetime64[ns] (timezone aware)
- Open: float64
- High: float64  
- Low: float64
- Close: float64
- Volume: int64
- Dividends: float64
- Stock_Splits: float64
- symbol: string (object)
- daily_return: float64
- log_return: float64
- volatility_20d: float64
- volatility_5d: float64
- [指標固有の列]
```

### 3.3 設定上の日本株データスキーマ（未実装）

```
予想される構造:
- Date: datetime64[ns]
- Code: string (株式コード)
- Open: float64
- High: float64
- Low: float64
- Close: float64
- Volume: int64
- AdjustmentFactor: float64
- AdjustmentOpen: float64
- AdjustmentHigh: float64
- AdjustmentLow: float64
- AdjustmentClose: float64
- AdjustmentVolume: int64
```

## 4. データ処理パイプライン

### 4.1 実装済み処理機能

#### 外部データ取得
- **ExternalDataFetcher**: Yahoo Finance APIからの自動取得
- **対応指標**: USD/JPY, VIX, TOPIX, 日経先物（設定上）
- **技術指標生成**: 移動平均、ボラティリティ、乖離率

#### 日本株データ取得（実装済み、未実行）
- **JQuantsClient**: J-Quants API認証・データ取得
- **StockDataFetcher**: 日経225構成銘柄の一括取得
- **DataPreprocessor**: 調整後価格計算、欠損値処理
- **DataValidator**: データ品質チェック

#### 特徴量エンジニアリング（実装済み）
- **FeaturePipeline**: 121以上の特徴量生成
- **技術指標**: MA, RSI, MACD, BB, ストキャスティクス, ADX, ATR
- **市場環境特徴量**: 外部指標との関係性
- **データリーク防止**: 未来情報の除外

## 5. データ設定と制約

### 5.1 設定ファイル（config.yaml）

#### データ期間設定
```yaml
data:
  start_date: "2016-01-01"
  end_date: "2024-12-31"
  train_end_date: "2022-12-30"
  val_end_date: "2023-12-30" 
  test_end_date: "2024-12-31"
```

#### 特徴量設定
```yaml
features:
  ma_periods: [5, 10, 20, 60, 120]
  rsi_period: 14
  bb_period: 20
  bb_std: 2
```

#### ラベル設定
```yaml
labels:
  target_return: 0.01  # 1%リターン閾値
  lookahead_days: 1    # 翌営業日
```

### 5.2 API制約

#### J-Quants API
- **レート制限**: 100リクエスト/分
- **認証**: メールアドレス・パスワード・リフレッシュトークン
- **タイムアウト**: 30秒

#### Yahoo Finance
- **非公式API**: 安定性に課題
- **レート制限**: 制限あり（詳細は非公開）

## 6. データ欠損と対処状況

### 6.1 現在の欠損状況

#### 主要データ欠損
- **日本株データ**: 完全に欠損（J-Quants APIから未取得）
- **日経225構成銘柄リスト**: 未取得
- **TOPIX・日経先物データ**: 未取得

#### 利用可能データ
- **USD/JPYデータ**: 2022年11月～2023年4月（約5.3ヶ月）
- **VIXデータ**: 同上期間
- **テスト用サンプルデータ**: 各評価機能で生成済み

### 6.2 対処方針

#### 短期対策
- テスト用サンプルデータでの機能検証継続
- 既存の外部指標データでの部分的検証

#### 中期対策（Phase 8以降）
- J-Quants APIからの日本株データ取得実行
- 日経225構成銘柄の動的取得・管理
- 不足している外部指標データの取得

## 7. データ品質と検証

### 7.1 実装済み品質チェック

#### DataValidator機能
- **欠損値検出**: 許容範囲内の欠損率チェック
- **外れ値検出**: 分位点ベースのクリッピング
- **データ一貫性**: 日付整合性、価格データ妥当性
- **重複データ**: 重複レコードの検出・除去

#### 前処理機能
- **欠損値処理**: 前方・後方補完（ffill/bfill）
- **外れ値処理**: 1%・99%分位点クリッピング
- **正規化**: 標準化・min-max正規化
- **データリーク防止**: 時系列順序の厳密管理

### 7.2 品質課題

#### 既存データの制約
- **期間の短さ**: 約5.3ヶ月のみ（本来は9年間必要）
- **銘柄数の不足**: 実際の日本株データなし
- **外部指標の不足**: TOPIX、日経先物データなし

## 8. パフォーマンス検証結果

### 8.1 Phase 7評価システムテスト結果

#### バックテストシステム
- **処理対象**: 46取引のシミュレーション
- **パフォーマンス**: 勝率47.8%、リターン-6.76%
- **処理時間**: 約2秒（可視化含む）
- **出力**: 詳細レポート・チャート生成成功

#### 精度分析システム
- **処理対象**: 4ヶ月間・9銘柄のデータ
- **分析項目**: 時系列・銘柄別・市場環境・信頼度分析
- **処理時間**: 約2.4秒（可視化含む）
- **出力**: 包括的レポート・多次元分析成功

## 9. 次段階でのデータ要件

### 9.1 Phase 8（モデル・データ精度向上）で必要なデータ

#### 必須データ
- **日経225株価データ**: 2016年～2024年（約9年間）
- **調整後価格データ**: 株式分割・配当調整済み
- **出来高データ**: 流動性分析用
- **銘柄メタデータ**: セクター・時価総額・上場年数

#### 追加外部指標
- **TOPIX**: 市場全体のトレンド把握
- **日経先物**: 市場センチメント
- **業種別指数**: セクターローテーション分析
- **マクロ経済指標**: GDP、CPI、金利動向

### 9.2 データ整備計画

#### 優先度1（必須）
- J-Quants APIからの日経225データ一括取得
- データ品質チェック・クリーニング実行
- 時系列整合性検証・データギャップ補完

#### 優先度2（重要）  
- 外部指標データの期間延長
- セクター・メタデータの充実
- データ更新自動化システム

#### 優先度3（改善）
- ニュース・感情分析データ
- ESGスコア・企業業績データ
- 高頻度データ（分足・時間足）

## 10. まとめ

### 10.1 現在のデータ状況
- **実データ**: USD/JPY・VIX（約5.3ヶ月）のみ
- **日本株データ**: 実装済みだが未取得
- **テスト環境**: Phase 7検証完了済み
- **機能実装**: データ処理パイプライン完成

### 10.2 次段階への準備
- データ取得システムは完全に実装済み
- 品質管理・前処理機能も準備完了
- Phase 8でのデータ整備が最優先課題

### 10.3 技術的成果
- 堅牢なデータ処理パイプライン構築
- 包括的な品質管理システム
- 効率的なParquet形式での大容量データ対応
- APIレート制限・エラーハンドリング実装

**この段階では、システムの骨格は完成しており、実際のデータを投入することで本格的な検証・運用が可能な状態です。**